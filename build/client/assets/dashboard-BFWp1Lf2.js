const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/InteractiveMap-BKLau9Yx.js","assets/jsx-runtime-CQPF1LdT.js","assets/components-DwAki7mf.js","assets/firestore.service-B-C4dBwJ.js","assets/index-C9mCl7jc.js"])))=>i.map(i=>d[i]);
import{j as e,r as c}from"./jsx-runtime-CQPF1LdT.js";import{F as i,c as k,l as G,m as M,f as V,d as se,n as ne,o as O,p as re}from"./index-C9mCl7jc.js";import{f as ae,p as le,h as ce,i as ie,j as oe,k as de,l as ue}from"./firestore.service-B-C4dBwJ.js";import{L as me,a as xe,u as he}from"./components-DwAki7mf.js";const fe="modulepreload",ge=function(t){return"/"+t},W={},je=function(a,n,r){let o=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),u=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));o=Promise.allSettled(n.map(d=>{if(d=ge(d),d in W)return;W[d]=!0;const f=d.endsWith(".css"),p=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${p}`))return;const m=document.createElement("link");if(m.rel=f?"stylesheet":fe,f||(m.as="script"),m.crossOrigin="",m.href=d,u&&m.setAttribute("nonce",u),document.head.appendChild(m),f)return new Promise((v,E)=>{m.addEventListener("load",v),m.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${d}`)))})}))}function h(s){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=s,window.dispatchEvent(u),!u.defaultPrevented)throw s}return o.then(s=>{for(const u of s||[])u.status==="rejected"&&h(u.reason);return a().catch(h)})},pe=t=>t.toLowerCase().includes("ticket")?"ticket SAP":t.toLowerCase().includes("envois")?"envois CTN":t.toLowerCase().includes("client")?"clients actifs":"données",ve=({title:t,value:a,icon:n,isLoading:r=!1,evolutionValue:o})=>{const h=typeof o=="number"&&o!==0,s=o&&o>0,u=s?"text-green-500":"text-red-500",d=s?"↑":"↓",f=pe(t);return e.jsxs("div",{className:"bg-jdc-card p-4 rounded-lg shadow-lg flex items-start space-x-4 transition-colors duration-200 hover:bg-jdc-gray-800",children:[e.jsx("div",{className:"p-3 rounded-full bg-jdc-yellow text-black flex-shrink-0 mt-1",children:e.jsx(i,{icon:n,className:"h-6 w-6"})}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("p",{className:"text-sm text-jdc-gray-400",children:t}),e.jsx("p",{className:`text-2xl font-semibold text-white mt-1 ${r?"animate-pulse":""}`,children:r?e.jsx(i,{icon:k,spin:!0}):a}),!r&&h&&e.jsxs("p",{className:`text-xs font-medium ${u} mt-1`,children:["évolution ",f," (24h) : ",d," ",s?"+":"",o]}),!r&&!h&&e.jsxs("p",{className:"text-xs font-medium text-transparent mt-1 h-[1em]",children:[" ","  "]})]})]})},be={theme:{extend:{colors:{"jdc-yellow":"#FFD700"}}}},ye=be.theme.extend.colors["jdc-yellow"],Ne=({tickets:t,isLoading:a=!1,error:n=null})=>{const r=s=>s.raisonSociale||s.codeClient||"Client inconnu",o=s=>s?s.length>40?s.substring(0,40)+"...":s:"Pas de résumé",h=s=>{switch(s){case"Nouveau":return"bg-green-600 text-white";case"Demande de RMA":return"bg-blue-600 text-white";case"Ouvert":return"bg-red-600 text-white";case"En cours":return"bg-yellow-500 text-black";case"Fermé":return"bg-gray-600 text-white";default:return"bg-gray-500 text-white"}};return e.jsxs("div",{className:"bg-jdc-card p-4 rounded-lg shadow-lg",children:[e.jsxs("h2",{className:"text-xl font-semibold text-white mb-3 flex items-center",children:[e.jsx(i,{icon:G,className:"mr-2",color:ye}),"Tickets SAP Récents"]}),a&&e.jsxs("div",{className:"flex items-center justify-center text-jdc-gray-300 py-4",children:[e.jsx(i,{icon:k,spin:!0,className:"mr-2"}),"Chargement..."]}),n&&!a&&e.jsxs("div",{className:"flex items-center text-red-400 py-4",children:[e.jsx(i,{icon:M,className:"mr-2"}),"Erreur: ",n]}),!a&&!n&&t.length===0&&e.jsx("p",{className:"text-jdc-gray-400 text-center py-4",children:"Aucun ticket récent à afficher."}),!a&&!n&&t.length>0&&e.jsx("ul",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:t.map(s=>e.jsxs("li",{className:"flex justify-between items-start text-sm p-2 bg-jdc-gray-800 rounded hover:bg-jdc-gray-700",children:[e.jsxs("div",{className:"flex-grow mr-2",children:[e.jsx("span",{className:"font-medium text-white block",children:r(s)}),e.jsxs("span",{className:"text-jdc-gray-400 block text-xs",children:[o(s.summary)," - ",s.secteur||"Secteur N/A"]}),e.jsx("span",{className:"text-jdc-gray-500 block text-xs italic",children:ae(le(s.date))})]}),e.jsx("div",{className:"flex-shrink-0 text-right",children:e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-semibold whitespace-nowrap ${h(s.statut)}`,children:s.statut||"N/A"})})]},s.id))})]})},Ce=t=>{if(!Array.isArray(t))return[];const a=new Set;return t.forEach(n=>{n.nomClient&&a.add(n.nomClient)}),Array.from(a).sort((n,r)=>n.localeCompare(r))},we=({shipments:t,isLoading:a})=>{const n=c.useMemo(()=>Ce(t),[t]);return e.jsxs("div",{className:"bg-jdc-card p-4 rounded-lg shadow-lg",children:[e.jsxs("h2",{className:"text-xl font-semibold text-white mb-3 flex items-center",children:[e.jsx(i,{icon:V,className:"mr-2 text-jdc-yellow"}),"Clients CTN Récents (via Envois)"]}),a?e.jsxs("div",{className:"flex items-center justify-center text-jdc-gray-300 py-4",children:[e.jsx(i,{icon:V,spin:!0,className:"mr-2"}),"Chargement..."]}):n.length===0?e.jsx("p",{className:"text-jdc-gray-400 text-center py-4",children:"Aucun client trouvé dans les envois récents."}):e.jsx("ul",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:n.map(r=>e.jsx("li",{className:"text-sm p-2 bg-jdc-gray-800 rounded hover:bg-jdc-gray-700 transition-colors duration-150",children:e.jsxs(me,{to:`/envois-ctn?client=${encodeURIComponent(r)}`,className:"flex items-center w-full",children:[e.jsx(i,{icon:se,className:"mr-2 text-jdc-gray-300 flex-shrink-0"})," ",e.jsx("span",{className:"font-medium text-white truncate",title:r,children:r})]})},r))})]})};function Se({children:t,fallback:a=null}){const[n,r]=c.useState(!1);return c.useEffect(()=>{r(!0)},[]),n?t():a}const ke=c.lazy(()=>je(()=>import("./InteractiveMap-BKLau9Yx.js"),__vite__mapDeps([0,1,2,3,4]))),$e=()=>[{title:"Tableau de Bord | JDC Dashboard"}],H=()=>e.jsxs("div",{className:"bg-jdc-card p-4 rounded-lg shadow-lg flex flex-col items-center justify-center min-h-[450px]",children:[e.jsx(i,{icon:k,spin:!0,className:"text-jdc-yellow text-3xl mb-4"}),e.jsx("p",{className:"text-jdc-gray-400 text-center",children:"Chargement de la carte..."})]}),Ee=()=>e.jsxs("div",{className:"bg-jdc-card p-4 rounded-lg shadow-lg flex flex-col items-center justify-center min-h-[450px]",children:[e.jsx(i,{icon:re,className:"text-jdc-gray-500 text-4xl mb-4"}),e.jsx("p",{className:"text-jdc-gray-400 text-center",children:"Connectez-vous pour voir la carte des tickets."})]}),Te=({events:t,error:a,isLoading:n})=>n?e.jsxs("div",{className:"bg-jdc-card p-4 rounded-lg shadow-lg min-h-[200px] flex items-center justify-center",children:[e.jsx(i,{icon:k,spin:!0,className:"text-jdc-yellow text-xl mr-2"}),e.jsx("span",{className:"text-jdc-gray-400",children:"Chargement de l'agenda..."})]}):a?e.jsxs("div",{className:"bg-jdc-card p-4 rounded-lg shadow-lg min-h-[200px]",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-2 flex items-center",children:[e.jsx(i,{icon:O,className:"mr-2 text-jdc-blue"}),"Agenda de la semaine"]}),e.jsxs("div",{className:"text-red-400 bg-red-900 bg-opacity-50 p-3 rounded",children:[e.jsx(i,{icon:M,className:"mr-1"})," ",a]})]}):t.length===0?e.jsxs("div",{className:"bg-jdc-card p-4 rounded-lg shadow-lg min-h-[200px]",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-2 flex items-center",children:[e.jsx(i,{icon:O,className:"mr-2 text-jdc-blue"}),"Agenda de la semaine"]}),e.jsx("p",{className:"text-jdc-gray-400",children:"Aucun événement trouvé pour cette période."})]}):e.jsxs("div",{className:"bg-jdc-card p-4 rounded-lg shadow-lg min-h-[200px]",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center",children:[e.jsx(i,{icon:O,className:"mr-2 text-jdc-blue"}),"Agenda de la semaine"]}),e.jsx("ul",{className:"space-y-2",children:t.map(r=>e.jsxs("li",{className:"text-sm border-b border-jdc-gray-700 pb-1 last:border-b-0",children:[e.jsx("span",{className:"font-medium text-jdc-gray-200",children:r.summary||"(Sans titre)"}),e.jsxs("span",{className:"text-xs text-jdc-gray-400 ml-2",children:["(",Y(r.start)," - ",Y(r.end),")"]}),r.htmlLink&&e.jsx("a",{href:r.htmlLink,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-jdc-blue hover:underline ml-2",children:"(Voir)"})]},r.id))})]}),Y=t=>{if(!t)return"N/A";if(t.dateTime)try{return new Date(t.dateTime).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}catch{return"Heure invalide"}if(t.date)try{const[a,n,r]=t.date.split("-").map(Number);return new Date(a,n-1,r).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}catch{return"Date invalide"}return"N/A"};function Pe(){const{user:t,profile:a,profileLoading:n}=xe(),{calendarEvents:r,calendarError:o}=he(),[h,s]=c.useState(null),[u,d]=c.useState(null),[f,p]=c.useState({ticketCount:null,distinctClientCountFromEnvoi:null}),[m,v]=c.useState([]),[E,T]=c.useState([]),[D,A]=c.useState(!0),[F,L]=c.useState(!0),[q,R]=c.useState(!0),[b,g]=c.useState(null),[Q,De]=c.useState(0);c.useEffect(()=>{(async()=>{if(n){console.log("Dashboard Effect: Waiting for profile to load...");return}if(t&&!a&&console.warn("Dashboard Effect: User session exists but profile is null after loading."),!t){A(!1),L(!1),R(!1),s(null),d(null),p({ticketCount:null,distinctClientCountFromEnvoi:null}),v([]),T([]),g(null);return}A(!0),L(!0),R(!0),g(null),console.log("Dashboard Effect: Fetching client-side data (stats, tickets, shipments)...");try{const l=a,C=(l==null?void 0:l.secteurs)??[],y=C,$=(l==null?void 0:l.role)==="Admin"?[]:C;console.log(`Dashboard Effect: Using sectors for tickets: ${JSON.stringify(y)}`),console.log(`Dashboard Effect: Using sectors for shipments: ${$.length===0&&(l==null?void 0:l.role)==="Admin"?"(Admin - All)":JSON.stringify($)}`);const j=await Promise.allSettled([ce(1),ie(y),oe(l),de(y,20),ue($,20)]),w=j[0],I=j[1],B=j[2],N=w.status==="fulfilled"&&w.value.length>0?w.value[0]:null,P=I.status==="fulfilled"?I.value:null,U=B.status==="fulfilled"?B.value:null;j.forEach((K,S)=>{K.status==="rejected"&&(console.error(`Dashboard Effect: Error fetching client-side data at index ${S}:`,K.reason),b||(S===0&&g("Erreur chargement évolution."),S===1&&g("Erreur chargement total tickets."),S===2&&g("Erreur chargement clients distincts.")))}),s(P),d(U);const _={ticketCount:null,distinctClientCountFromEnvoi:null};N?(P!==null&&N.totalTickets!==void 0&&(_.ticketCount=P-N.totalTickets),U!==null&&N.activeClients!==void 0&&(_.distinctClientCountFromEnvoi=U-N.activeClients)):w.status==="rejected"&&!b&&g("Données snapshot manquantes."),p(_);const z=j[3],J=j[4];v(z.status==="fulfilled"?z.value:[]),T(J.status==="fulfilled"?J.value:[])}catch(l){g(l.message||"Erreur générale chargement données client."),s(null),d(null),p({ticketCount:null,distinctClientCountFromEnvoi:null}),v([]),T([])}finally{A(!1),L(!1),R(!1),console.log("Dashboard Effect: Client-side data fetching finished.")}})()},[t,a,n,Q]);const X=(x,l)=>l?"...":x==null?"N/A":x.toString(),Z=[{title:"Tickets SAP (Total)",valueState:h,icon:G,evolutionKey:"ticketCount",loadingState:D},{title:"Clients CTN (Distincts)",valueState:u,icon:ne,evolutionKey:"distinctClientCountFromEnvoi",loadingState:D}],ee=D||F||q||n,te=m.slice(0,5);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-3xl font-semibold text-white",children:"Tableau de Bord"}),b&&e.jsxs("div",{className:"flex items-center p-4 bg-red-800 text-white rounded-lg mb-4",children:[e.jsx(i,{icon:M,className:"mr-2"}),b]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:Z.map(x=>{const l=x.loadingState,C=x.valueState,y=f[x.evolutionKey];return e.jsx(ve,{title:x.title,value:X(C,l),icon:x.icon,isLoading:l,evolutionValue:y},x.title)})}),e.jsx(Te,{events:r,error:o,isLoading:!t&&!o}),e.jsx("div",{className:"w-full mb-6",children:e.jsx(Se,{fallback:e.jsx(H,{}),children:()=>t?e.jsx(c.Suspense,{fallback:e.jsx(H,{}),children:e.jsx(ke,{tickets:m,isLoadingTickets:F})}):e.jsx(Ee,{})})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(Ne,{tickets:te,isLoading:F}),e.jsx(we,{shipments:E,isLoading:q})]}),!t&&!ee&&!b&&e.jsx("div",{className:"p-4 bg-jdc-card rounded-lg text-center text-jdc-gray-300 mt-6",children:"Veuillez vous connecter pour voir le tableau de bord."})]})}export{Pe as D,je as _,$e as m};
