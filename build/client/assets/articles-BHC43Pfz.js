import{r as o,j as e}from"./jsx-runtime-CQPF1LdT.js";import{s as Q,b as W,c as X}from"./firestore.service-B-C4dBwJ.js";import{F as m,c as _,i as Z,j as ee,k as re}from"./index-C9mCl7jc.js";import{u as se,b as te,a as ae,F as oe}from"./components-DwAki7mf.js";function ue(){const{searchParams:U}=se(),[d]=te(),{user:x,loadingAuth:f}=ae(),[A,u]=o.useState([]),[b,y]=o.useState(!1),[j,N]=o.useState(null),[T,I]=o.useState(U.code),[z,k]=o.useState(U.nom),[E,v]=o.useState(null),[D,g]=o.useState(null),c=o.useRef(null),[F,P]=o.useState(null),[M,R]=o.useState(!1),[Y,L]=o.useState(null),[$,w]=o.useState(null);o.useEffect(()=>{var s,a;const r=((s=d.get("code"))==null?void 0:s.trim())||"",t=((a=d.get("nom"))==null?void 0:a.trim())||"";I(r),k(t),!f&&x&&(r||t)?(async()=>{y(!0),N(null),u([]),console.log("Client Search: Performing search for",{code:r,nom:t});try{const n=await Q({code:r,nom:t});u(n),console.log("Client Search: Found results",n)}catch(n){console.error("Client Search: Error fetching articles",n),N(n.message||"Erreur lors de la recherche côté client.")}finally{y(!1)}})():(u([]),y(!1),N(null))},[d,f,x]);const q=r=>{g(null),v(null),c.current&&(c.current.setAttribute("data-article-id",r),c.current.click())},H=async r=>{var a,l;const t=(a=r.target.files)==null?void 0:a[0],s=r.target.getAttribute("data-article-id");if(t&&s){console.log(`Fichier sélectionné: ${t.name} pour l'article ID: ${s}`),v(s),g(null),w(null);const n="dkeqzl54y",G="jdc-img",J=`https://api.cloudinary.com/v1_1/${n}/image/upload`,C=new FormData;C.append("file",t),C.append("upload_preset",G);try{console.log(`Upload vers Cloudinary pour l'article ${s}...`);const i=await fetch(J,{method:"POST",body:C});if(!i.ok){const p=await i.json();throw console.error("Erreur API Cloudinary:",p),new Error(((l=p.error)==null?void 0:l.message)||`Échec de l'upload Cloudinary (HTTP ${i.status})`)}const S=(await i.json()).secure_url;console.log("Upload Cloudinary réussi. URL:",S),await W(s,S),console.log("Mise à jour Firestore terminée pour",s),u(p=>p.map(h=>{if(h.id===s){const K=[...h.imageUrls||[],S];return{...h,imageUrls:K}}return h}))}catch(i){console.error("Erreur pendant l'upload ou la mise à jour Firestore:",i),g(i.message||"Échec de l'upload de l'image.")}finally{v(null),c.current&&(c.current.value="",c.current.removeAttribute("data-article-id"))}}else c.current&&c.current.removeAttribute("data-article-id")},V=r=>{P(r),R(!0)},O=()=>{R(!1),P(null)},B=async(r,t)=>{if(window.confirm("Êtes-vous sûr de vouloir supprimer cette image ? Cette action est irréversible.")){console.log(`Tentative de suppression de l'image: ${t} pour l'article: ${r}`),L(t),w(null),g(null);try{await X(r,t),console.log("Suppression de l'URL dans Firestore réussie."),u(s=>s.map(a=>{if(a.id===r){const l=(a.imageUrls||[]).filter(n=>n!==t);return{...a,imageUrls:l}}return a}))}catch(s){console.error("Erreur pendant la suppression de l'URL de l'image:",s),w(s.message||"Échec de la suppression de l'image.")}finally{L(null)}}};return e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4 text-gray-100",children:"Recherche d'Articles"}),e.jsx(oe,{method:"get",className:"mb-6 p-4 border border-gray-700 rounded-lg shadow-sm bg-jdc-blue-darker",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"code",className:"block text-sm font-medium text-gray-300 mb-1",children:"Code Article"}),e.jsx("input",{type:"text",name:"code",id:"code",value:T,onChange:r=>I(r.target.value),className:"w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-jdc-gray-800 text-gray-100 placeholder-gray-400",placeholder:"Code exact"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"nom",className:"block text-sm font-medium text-gray-300 mb-1",children:"Nom Article"}),e.jsx("input",{type:"text",name:"nom",id:"nom",value:z,onChange:r=>k(r.target.value),className:"w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-jdc-gray-800 text-gray-100 placeholder-gray-400",placeholder:"Nom partiel ou complet"})]}),e.jsx("div",{className:"md:pt-6",children:e.jsx("button",{type:"submit",className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline transition duration-150 ease-in-out",children:"Rechercher"})})]})}),e.jsxs("div",{className:"bg-jdc-blue-darker p-4 border border-gray-700 rounded-lg shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3 text-gray-200",children:"Résultats"}),b&&e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des articles..."}),j&&!b&&e.jsx("p",{className:"text-red-500 text-sm",children:j}),$&&e.jsx("p",{className:"text-red-500 text-sm mt-2",children:$})," ",!b&&!j&&e.jsx(e.Fragment,{children:A.length>0?e.jsx("ul",{className:"divide-y divide-gray-700",children:A.map(r=>{const t=E===r.id;return e.jsxs("li",{className:"py-4 px-1 hover:bg-jdc-gray-800",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-100",children:["Code: ",r.Code]}),e.jsxs("p",{className:"text-sm text-gray-300",children:["Désignation: ",r.Désignation]}),r.imageUrls&&r.imageUrls.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:r.imageUrls.map((s,a)=>{const l=Y===s;return e.jsxs("div",{className:"relative group",children:[" ",e.jsx("img",{src:s,alt:`Image ${a+1} pour ${r.Code}`,className:`h-16 w-16 object-cover rounded border border-gray-600 transition-opacity ${l?"opacity-50":"group-hover:opacity-70 cursor-pointer"}`,loading:"lazy",onClick:()=>!l&&V(s)}),e.jsx("button",{type:"button",onClick:n=>{n.stopPropagation(),B(r.id,s)},disabled:l,className:`absolute top-0 right-0 p-1 bg-red-600 bg-opacity-75 rounded-full text-white opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity ${l?"cursor-not-allowed opacity-50":"hover:bg-red-700"}`,"aria-label":"Supprimer l'image",children:l?e.jsx(m,{icon:_,spin:!0,className:"h-3 w-3"}):e.jsx(m,{icon:Z,className:"h-3 w-3"})})]},a)})})]}),e.jsx("div",{className:"ml-4 flex-shrink-0",children:e.jsxs("button",{type:"button",onClick:()=>q(r.id),disabled:t,className:`inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded shadow-sm text-white ${t?"bg-gray-500 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-jdc-blue-darker focus:ring-indigo-500"}`,children:[t?e.jsx(m,{icon:_,spin:!0,className:"mr-2"}):e.jsx(m,{icon:ee,className:"-ml-1 mr-2 h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:t?"Upload...":"Photo"})]})})]}),D&&E===r.id&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:D})]},r.id)})}):e.jsxs("p",{className:"text-gray-400 italic",children:[d.get("code")||d.get("nom")?"Aucun article trouvé pour ces critères.":"Effectuez une recherche pour afficher les résultats.",!x&&!f&&" Veuillez vous connecter pour effectuer une recherche."]})})]}),e.jsx("input",{type:"file",ref:c,onChange:H,accept:"image/*",style:{display:"none"},"data-article-id":""}),M&&F&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",onClick:O,children:e.jsxs("div",{className:"relative bg-white p-2 rounded-lg max-w-3xl max-h-[80vh]",onClick:r=>r.stopPropagation(),children:[e.jsx("img",{src:F,alt:"Image agrandie",className:"block max-w-full max-h-[calc(80vh-40px)] object-contain"}),e.jsx("button",{onClick:O,className:"absolute top-2 right-2 text-black bg-white bg-opacity-50 hover:bg-opacity-75 rounded-full p-1 focus:outline-none","aria-label":"Fermer l'image",children:e.jsx(m,{icon:re,size:"lg"})})]})})]})}export{ue as default};
