import{r as n,j as e}from"./jsx-runtime-CQPF1LdT.js";import{d as z,g as B,a as R}from"./firestore.service-B-C4dBwJ.js";import{I as U}from"./Input-DDK31hED.js";import{B as T}from"./Button-CsBiVYsy.js";import{F as u,f as V,a as q,b as J,c as O,d as _,e as H,g as K,h as Q}from"./index-C9mCl7jc.js";import{g as W}from"./styleUtils-BGyYvGHo.js";import{u as X}from"./ToastContext-BMoWAI_y.js";import{a as Y,b as Z}from"./components-DwAki7mf.js";const ie=()=>[{title:"Envois CTN | JDC Dashboard"}],ee=m=>{const i=new Map;return Array.isArray(m)&&m.forEach(l=>{const h=l.nomClient||"Client Inconnu",c=i.get(h);c?c.push(l):i.set(h,[l])}),i};function de(){const{user:m}=Y(),{addToast:i}=X(),[l,h]=n.useState(null),[c,j]=n.useState([]),[d,C]=n.useState(!0),[v,$]=n.useState(null),[S,I]=n.useState(null),[b,F]=n.useState(""),[E]=Z(),M=E.get("client")||"",[g,D]=n.useState(M);n.useEffect(()=>{const s=E.get("client");s&&s!==g&&D(s)},[E,g]),n.useEffect(()=>{(async()=>{if(!m){C(!1),j([]),h(null);return}C(!0),$(null);try{const t=await B(m.uid);if(h(t),!t)throw j([]),new Error("Profil utilisateur introuvable.");const r=await R(t);j(r)}catch(t){console.error("Error fetching data for Envois CTN:",t);const r=t instanceof Error?t.message:String(t);$(`Erreur de chargement des données: ${r}`),j([])}finally{C(!1)}})()},[m]);const L=n.useMemo(()=>{let s=c;if(l==null||l.role,b&&b!==""&&(s=s.filter(t=>t.secteur===b)),g.trim()!==""){const t=g.trim().toLowerCase();s=s.filter(r=>r.nomClient&&r.nomClient.toLowerCase().includes(t)||r.codeClient&&r.codeClient.toLowerCase().includes(t)||r.id&&r.id.toLowerCase().includes(t)||r.articleNom&&r.articleNom.toLowerCase().includes(t))}return ee(s)},[c,b,g,l]),k=n.useMemo(()=>Array.from(L.entries()).sort((t,r)=>t[0].localeCompare(r[0])),[L]),N=n.useMemo(()=>{const s=new Set(c.map(t=>t.secteur).filter(Boolean));return Array.from(s).sort()},[c]),G=n.useCallback(async(s,t)=>{if(!t||t.length===0)return;const r=t.length;if(window.confirm(`Êtes-vous sûr de vouloir supprimer les ${r} envoi${r>1?"s":""} pour le client "${s}" ? Cette action est irréversible.`)){I(s);const y=t.map(o=>o.id),A=y.map(o=>z(o));try{const o=await Promise.allSettled(A),p=o.filter(x=>x.status==="fulfilled").length,w=o.filter(x=>x.status==="rejected").length;if(w>0){console.error(`Failed to delete ${w} shipments for client ${s}.`);const x=o.filter(f=>f.status==="rejected").map(f=>f.reason instanceof Error?f.reason.message:String(f.reason)).join(", ");i({type:"error",message:`Erreur lors de la suppression de ${w} envoi${w>1?"s":""} pour ${s}. Détails: ${x}`})}p>0&&(j(x=>x.filter(f=>!y.includes(f.id))),i({type:"success",message:`${p} envoi${p>1?"s":""} pour ${s} supprimé${p>1?"s":""} avec succès.`}))}catch(o){console.error("Unexpected error during group deletion:",o);const p=o instanceof Error?o.message:String(o);i({type:"error",message:`Erreur inattendue lors de la suppression du groupe: ${p}`})}finally{I(null)}}},[i]),P=(l==null?void 0:l.role)==="Admin";return!m&&!d?e.jsx("div",{className:"text-center text-jdc-gray-400 py-10",children:"Veuillez vous connecter pour voir les envois."}):e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-semibold text-white mb-4 flex items-center",children:[e.jsx(u,{icon:V,className:"mr-3 text-jdc-yellow"}),"Suivi des Envois CTN"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-jdc-card rounded-lg shadow",children:[e.jsxs("div",{className:"col-span-1",children:[e.jsxs("label",{htmlFor:"sector-filter",className:"block text-sm font-medium text-jdc-gray-300 mb-1",children:[e.jsx(u,{icon:q,className:"mr-1"})," Filtrer par Secteur"]}),e.jsxs("select",{id:"sector-filter",name:"sector-filter",value:b,onChange:s=>F(s.target.value),className:"block w-full rounded-md bg-jdc-gray-800 border-transparent focus:border-jdc-yellow focus:ring focus:ring-jdc-yellow focus:ring-opacity-50 text-white py-2 pl-3 pr-10",disabled:d||N.length===0,children:[e.jsx("option",{value:"",children:"Tous les secteurs"}),N.map(s=>e.jsx("option",{value:s,children:s},s))]}),N.length===0&&!d&&c.length>0&&e.jsx("p",{className:"text-xs text-jdc-gray-500 mt-1",children:"Aucun secteur trouvé dans les envois affichés."}),N.length===0&&!d&&c.length===0&&!v&&e.jsx("p",{className:"text-xs text-jdc-gray-500 mt-1",children:"Aucun envoi accessible trouvé."})]}),e.jsx("div",{className:"col-span-1 md:col-span-2",children:e.jsx(U,{label:"Rechercher (Client, ID, Article...)",id:"search-client",name:"search-client",placeholder:"Entrez un nom, code, ID, article...",value:g,onChange:s=>D(s.target.value),icon:e.jsx(u,{icon:J}),wrapperClassName:"mb-0",disabled:d})})]}),d&&e.jsxs("div",{className:"text-center text-jdc-gray-400 py-10",children:[e.jsx(u,{icon:O,spin:!0,className:"text-2xl mr-2"}),"Chargement des envois..."]}),v&&!d&&e.jsx("div",{className:"text-center text-red-400 bg-red-900 bg-opacity-50 p-4 rounded-lg",children:v}),!d&&!v&&k.length===0&&e.jsx("div",{className:"text-center text-jdc-gray-400 py-10",children:c.length>0?"Aucun envoi trouvé correspondant à votre recherche ou filtre.":"Aucun envoi accessible trouvé pour votre compte. Vérifiez vos secteurs assignés si vous n'êtes pas Admin."}),!d&&!v&&k.length>0&&e.jsx("div",{className:"space-y-3",children:k.map(([s,t])=>{var r;return e.jsx("div",{className:"bg-jdc-card rounded-lg shadow overflow-hidden",children:e.jsxs("details",{className:"group",children:[e.jsxs("summary",{className:"flex items-center justify-between p-4 cursor-pointer hover:bg-jdc-gray-800 list-none transition-colors gap-4",children:[e.jsxs("div",{className:"flex items-center min-w-0 mr-2 flex-grow",children:[e.jsx(u,{icon:_,className:"mr-3 text-jdc-gray-300 text-lg flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("span",{className:"font-semibold text-white text-lg block truncate",title:s,children:s}),e.jsxs("span",{className:"ml-0 md:ml-3 text-sm text-jdc-gray-400",children:["(",t.length," envoi",t.length>1?"s":"",")"]}),((r=t[0])==null?void 0:r.codeClient)&&t[0].codeClient!==s&&e.jsxs("span",{className:"block text-xs text-jdc-gray-500 truncate",title:`Code: ${t[0].codeClient}`,children:["Code: ",t[0].codeClient]})]})]}),e.jsxs("div",{className:"flex items-center flex-shrink-0 space-x-3",children:[P&&e.jsx(T,{variant:"danger",size:"sm",title:`Supprimer tous les envois pour ${s}`,onClick:a=>{a.preventDefault(),a.stopPropagation(),G(s,t)},isLoading:S===s,disabled:S!==null&&S!==s,leftIcon:e.jsx(u,{icon:H}),className:"flex-shrink-0",children:"Suppr. Groupe"}),e.jsx(u,{icon:K,className:"text-jdc-gray-400 transition-transform duration-200 group-open:rotate-90 text-xl flex-shrink-0"})]})]}),e.jsx("div",{className:"border-t border-jdc-gray-700 bg-jdc-gray-900 p-4 space-y-3",children:t.map(a=>{const y=W(a.statutExpedition),A=a.articleNom&&a.articleNom.length>50?`${a.articleNom.substring(0,47)}...`:a.articleNom;return e.jsxs("div",{className:"flex items-center justify-between text-sm border-b border-jdc-gray-700 pb-2 last:border-b-0 gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0 mr-1",children:[e.jsx("span",{className:"text-jdc-gray-200 block font-medium truncate",title:a.articleNom,children:A||"Article non spécifié"}),e.jsxs("div",{className:"flex items-center flex-wrap mt-1 space-x-2",children:[e.jsx("span",{className:`inline-block px-2.5 py-0.5 rounded-full text-xs font-bold ${y.bgColor} ${y.textColor}`,children:a.statutExpedition||"Inconnu"}),e.jsxs("span",{className:"text-jdc-gray-500 text-xs whitespace-nowrap",title:`ID: ${a.id}`,children:["ID: ",a.id.substring(0,8),"..."]}),e.jsxs("span",{className:"text-jdc-gray-500 text-xs whitespace-nowrap",children:["Secteur: ",a.secteur||"N/A"]})]})]}),e.jsx("div",{className:"flex items-center flex-shrink-0 space-x-2",children:a.trackingLink&&e.jsx(T,{as:"link",to:a.trackingLink,target:"_blank",rel:"noopener noreferrer",variant:"secondary",size:"sm",title:"Suivre le colis",leftIcon:e.jsx(u,{icon:Q}),children:"Suivi"})})]},a.id)})})]})},s)})})]})}export{de as default,ie as meta};
