import{j as e,r as o}from"./jsx-runtime-CQPF1LdT.js";import{B as A}from"./Button-CsBiVYsy.js";import{I as P}from"./Input-DDK31hED.js";import{e as T,u as $}from"./firestore.service-B-C4dBwJ.js";import{u as I}from"./ToastContext-BMoWAI_y.js";import{a as O,L as M}from"./components-DwAki7mf.js";const C=({children:i,className:a="",as:t="div"})=>{const x=t;return e.jsx(x,{className:`bg-jdc-card rounded-lg shadow-lg overflow-hidden transition duration-200 ease-in-out hover:-translate-y-0.5 hover:shadow-xl ${a}`,children:i})},k=({children:i,className:a=""})=>e.jsx("div",{className:`px-4 py-3 sm:px-6 border-b border-jdc-gray-800 ${a}`,children:i}),L=({children:i,className:a=""})=>e.jsx("div",{className:`px-4 py-4 sm:p-6 ${a}`,children:i}),z=({label:i,id:a,name:t,options:x,value:u,onChange:g,disabled:c,required:h,error:n,className:f="",containerClassName:j="",...y})=>{const b="block w-full px-3 py-2 bg-jdc-gray-800 border border-jdc-gray-700 rounded-md shadow-sm placeholder-jdc-gray-500 focus:outline-none focus:ring-jdc-yellow focus:border-jdc-yellow sm:text-sm text-white disabled:opacity-50",N=n?"border-red-500 ring-red-500":"border-jdc-gray-700";return e.jsxs("div",{className:`mb-4 ${j}`,children:[i&&e.jsxs("label",{htmlFor:a||t,className:"block text-sm font-medium text-jdc-gray-300 mb-1",children:[i," ",h&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{id:a||t,name:t,value:u,onChange:g,disabled:c,required:h,className:`${b} ${N} ${f}`,...y,children:x.map(m=>e.jsx("option",{value:m.value,children:m.label},m.value))}),n&&e.jsx("p",{className:"mt-1 text-sm text-red-400",children:n})]})},D=["Admin","Technician","Viewer"],F=["CHR","HACCP","Kezia","Tabac"],V=({isOpen:i,onClose:a,user:t,onSave:x,availableRoles:u=D,availableSectors:g=F})=>{const[c,h]=o.useState({}),[n,f]=o.useState(!1),[j,y]=o.useState(null);o.useEffect(()=>{t&&i?(h({uid:t.uid,email:t.email,displayName:t.displayName||"",role:t.role||"Technician",secteurs:t.secteurs||[]}),y(null)):i||(h({}),f(!1),y(null))},[t,i]);const b=r=>{const{name:d,value:p}=r.target;h(s=>({...s,[d]:p}))},N=r=>{h(d=>{const p=d.secteurs||[],s=p.includes(r);let l;return s?l=p.filter(E=>E!==r):l=[...p,r],{...d,secteurs:l}})},m=async r=>{if(r.preventDefault(),!t)return;f(!0),y(null);const d={...t,displayName:c.displayName||t.displayName,role:c.role||t.role,secteurs:c.secteurs||[],uid:t.uid,email:t.email};try{await x(d)}catch(p){console.error("Error saving user:",p),y(p.message||"Erreur lors de la sauvegarde.")}finally{f(!1)}};if(!i||!t)return null;const S=u.map(r=>({value:r,label:r})),v=c.secteurs||[];return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 transition-opacity duration-300 ease-in-out",children:e.jsxs("div",{className:"bg-jdc-card rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all duration-300 ease-in-out scale-100",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-white",children:"Modifier l'utilisateur"}),e.jsx("button",{onClick:a,className:"text-jdc-gray-400 hover:text-white",disabled:n,children:"×"})]}),e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-jdc-gray-300 mb-1",children:"Email"}),e.jsx("p",{className:"text-sm text-white bg-jdc-gray-800 px-3 py-2 rounded",children:c.email})]}),e.jsx(P,{label:"Nom d'affichage",id:"displayName",name:"displayName",value:c.displayName||"",onChange:b,disabled:n,placeholder:"Nom affiché dans l'application"}),e.jsx(z,{label:"Rôle",id:"role",name:"role",options:S,value:c.role||"",onChange:b,disabled:n,required:!0}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-jdc-gray-300 mb-2",children:"Secteurs"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map(r=>{const d=v.includes(r);return e.jsx(A,{type:"button",variant:d?"primary":"secondary",size:"sm",onClick:()=>N(r),disabled:n,className:`transition-colors duration-150 ${d?"":"opacity-70 hover:opacity-100"}`,children:r},r)})})]}),j&&e.jsx("p",{className:"text-sm text-red-400 mt-2",children:j}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx(A,{type:"button",variant:"secondary",onClick:a,disabled:n,children:"Annuler"}),e.jsx(A,{type:"submit",variant:"primary",isLoading:n,disabled:n,children:"Enregistrer"})]})]})]})})},B=["CHR","HACCP","Kezia","Tabac"],H=["Admin","Technician","Viewer"];function W(){const{user:i,profile:a,loadingAuth:t}=O(),{addToast:x}=I(),[u,g]=o.useState(null),[c,h]=o.useState([]),[n,f]=o.useState(!1),[j,y]=o.useState(null),[b,N]=o.useState(!1),[m,S]=o.useState(null);o.useEffect(()=>{var l;if(t){g(null);return}const s=i&&((l=a==null?void 0:a.role)==null?void 0:l.toLowerCase())==="admin";g(s)},[i,a,t]);const v=o.useCallback(async()=>{console.log("[AdminPanel] Fetching user list..."),f(!0),y(null);try{const s=await T();console.log("[AdminPanel] User list fetched successfully:",s),h(s)}catch(s){console.error("[AdminPanel] Error fetching user list:",s);const l=s instanceof Error?s.message:"Erreur inconnue";y(`Impossible de charger la liste des utilisateurs: ${l}. Vérifiez les permissions Firestore ou la console.`),x({type:"error",message:"Erreur lors du chargement des utilisateurs."})}finally{f(!1)}},[x]);o.useEffect(()=>{u===!0?v():u===!1&&h([])},[u,v]);const r=s=>{console.log("[AdminPanel] Opening edit modal for user:",s.uid),S(s),N(!0)},d=()=>{console.log("[AdminPanel] Closing edit modal."),N(!1),S(null)},p=async s=>{if(!m)return;console.log("[AdminPanel] Attempting to save user (client-side):",s.uid,s);const l={};s.displayName!==m.displayName&&(l.displayName=s.displayName),s.role!==m.role&&(l.role=s.role);const E=[...m.secteurs||[]].sort(),U=[...s.secteurs||[]].sort();if(JSON.stringify(E)!==JSON.stringify(U)&&(l.secteurs=s.secteurs||[]),Object.keys(l).length===0){x({type:"info",message:"Aucune modification détectée."}),d();return}try{await $(m.uid,l),x({type:"success",message:"Utilisateur mis à jour avec succès."}),d(),v()}catch(w){console.error("[AdminPanel] Error saving user (client-side SDK):",w);const R=w instanceof Error?w.message:"Erreur inconnue";throw x({type:"error",message:`Erreur lors de la mise à jour : ${R}`}),w}};return t||u===null?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("p",{className:"text-jdc-gray-400 animate-pulse",children:"Vérification de l'accès..."})}):u?e.jsxs("div",{className:"space-y-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-6",children:"Panneau d'Administration"}),e.jsxs(C,{children:[e.jsx(k,{children:e.jsx("h2",{className:"text-lg font-medium text-white",children:"Informations Administrateur"})}),e.jsxs(L,{children:[e.jsxs("p",{className:"text-jdc-gray-300",children:["Connecté en tant que : ",e.jsx("span",{className:"font-medium text-white",children:a==null?void 0:a.email})]}),e.jsxs("p",{className:"text-jdc-gray-300",children:["Rôle : ",e.jsx("span",{className:"font-medium text-white",children:a==null?void 0:a.role})]})]})]}),e.jsxs(C,{children:[e.jsxs(k,{children:[e.jsx("h2",{className:"text-lg font-medium text-white",children:"Gestion des Utilisateurs Existants"}),e.jsx("p",{className:"mt-1 text-sm text-jdc-gray-400",children:"Modifier les rôles et les secteurs des utilisateurs."})]}),e.jsxs(L,{children:[e.jsxs("div",{className:"bg-red-900 border border-red-700 text-red-100 px-4 py-3 rounded relative mb-4",role:"alert",children:[e.jsx("strong",{className:"font-bold",children:"Attention Sécurité ! "}),e.jsx("span",{className:"block sm:inline",children:"La modification des utilisateurs est effectuée côté client via SDK. Ceci est INSECURISÉ pour les opérations sensibles (changement de rôle admin) et doit être remplacé par des fonctions backend sécurisées (ex: Cloud Functions) à terme."})]}),e.jsxs("div",{className:"bg-yellow-900 border border-yellow-700 text-yellow-100 px-4 py-3 rounded relative mb-4",role:"alert",children:[e.jsx("strong",{className:"font-bold",children:"Info : "}),e.jsx("span",{className:"block sm:inline",children:'La création de nouveaux utilisateurs se fait désormais via la fenêtre de connexion (bouton "Créer un compte").'})]}),n&&e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-jdc-gray-400 animate-pulse",children:"Chargement de la liste..."})}),j&&!n&&e.jsx("div",{className:"text-center py-4 text-red-400",children:e.jsx("p",{children:j})}),!n&&!j&&c.length>0&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-jdc-gray-700",children:[e.jsx("thead",{className:"bg-jdc-gray-800/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-jdc-gray-300 uppercase tracking-wider",children:"Nom"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-jdc-gray-300 uppercase tracking-wider",children:"Email"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-jdc-gray-300 uppercase tracking-wider",children:"Rôle"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-jdc-gray-300 uppercase tracking-wider",children:"Secteurs"}),e.jsx("th",{className:"relative px-6 py-3",children:e.jsx("span",{className:"sr-only",children:"Actions"})})]})}),e.jsx("tbody",{className:"bg-jdc-card divide-y divide-jdc-gray-700",children:c.map(s=>{var l;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-white",children:s.displayName||e.jsx("i",{className:"text-jdc-gray-500",children:"Non défini"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-jdc-gray-300",children:s.email}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-jdc-gray-300",children:s.role}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-jdc-gray-300",children:((l=s.secteurs)==null?void 0:l.join(", "))||e.jsx("i",{className:"text-jdc-gray-500",children:"Aucun"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsx(A,{variant:"secondary",size:"sm",onClick:()=>r(s),children:"Modifier"})})]},s.uid)})})]})}),!n&&!j&&c.length===0&&e.jsx("div",{className:"text-center py-4 text-jdc-gray-400",children:e.jsx("p",{children:"Aucun utilisateur trouvé."})})]})]}),e.jsx(V,{isOpen:b,onClose:d,user:m,onSave:p,availableRoles:H,availableSectors:B})]}):e.jsxs("div",{className:"text-center py-10",children:[e.jsx("h1",{className:"text-2xl font-bold text-red-500 mb-4",children:"Accès Refusé"}),e.jsx("p",{className:"text-jdc-gray-300",children:"Vous n'avez pas les permissions nécessaires."}),e.jsx(M,{to:"/dashboard",className:"text-jdc-yellow hover:underline mt-4 inline-block",children:"Retour au tableau de bord"})]})}export{W as default};
